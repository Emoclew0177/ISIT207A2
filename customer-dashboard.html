<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Dashboard | AZoom Car Rental</title>
  <link rel="stylesheet" href="styles.css">
  <!-- No page-specific styles needed; all styles are now in styles.css -->
</head>
<body>
  <header class="site-header">
    <div class="logo">AZOOM</div>
    <nav class="menu" id="hamburger-menu">
      <a href="index.html#home">Home</a>
      <div id="userMenu" style="display:inline-block;position:relative;">
        <a href="#" id="userMenuBtn" style="color:var(--accent-color);font-weight:800;">User ‚ñº</a>
        <div id="userDropdown" style="display:none;position:absolute;top:2.2rem;right:0;background:#222;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.18);min-width:160px;z-index:3000;">
          <a href="customer-dashboard.html" class="dropdown-link">Dashboard</a>
          <a href="#" id="logoutBtn" class="dropdown-link">Logout</a>
        </div>
      </div>
    </nav>
    <button class="menu-toggle" id="hamburger">‚ò∞</button>
  </header>
  <main class="page">
    <section class="dashboard-container">
      <div class="dashboard-header">
        <h2>Welcome, User</h2>
        <button class="logout-btn" id="logoutBtnMain">Logout</button>
      </div>
      <div class="reservations-section">
        <h3>Your Reservations</h3>
        <ul class="reservations-list">
          <!-- Reservation cards will be rendered by JS -->
        </ul>
      </div>
    </section>
  </main>
  <footer class="footer">
    <div class="footer-content">
      <h3>Follow Us</h3>
      <div class="social-links">
        <a href="https://facebook.com" target="_blank" rel="noopener noreferrer" title="Facebook">
          <span>f</span>
        </a>
        <a href="https://twitter.com" target="_blank" rel="noopener noreferrer" title="Twitter">
          <span>ùïè</span>
        </a>
        <a href="https://instagram.com" target="_blank" rel="noopener noreferrer" title="Instagram">
          <span>üì∑</span>
        </a>
        <a href="https://linkedin.com" target="_blank" rel="noopener noreferrer" title="LinkedIn">
          <span>in</span>
        </a>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2026 AZOOM. All rights reserved.</p>
    </div>
  </footer>
  <script>
    // User menu dropdown logic (for consistency)
    var userMenu = document.getElementById('userMenu');
    var userMenuBtn = document.getElementById('userMenuBtn');
    var userDropdown = document.getElementById('userDropdown');
    if (userMenuBtn && userDropdown) {
      userMenuBtn.addEventListener('click', (e) => {
        e.preventDefault();
        userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
      });
      document.addEventListener('click', (e) => {
        if (!userMenu.contains(e.target) && e.target !== userMenuBtn) {
          userDropdown.style.display = 'none';
        }
      });
    }
        // Show reservations from localStorage
        function renderReservations() {
          const user = localStorage.getItem('azoom_user') || 'User';
          let reservations = [];
          try {
            reservations = JSON.parse(localStorage.getItem('azoom_reservations') || '[]');
          } catch {}
          // Only show current user's
          const userReservations = reservations.filter(r => r.user === user);
          const list = document.querySelector('.reservations-list');
          if (!list) return;
          list.innerHTML = '';
          if (userReservations.length === 0) {
            list.innerHTML = '<li>No reservations found.</li>';
            return;
          }
          userReservations.forEach(res => {
            const li = document.createElement('li');
            // Format duration string
            let durationStr = '';
            if (res.period === 'daily') {
              durationStr = `${res.duration} day${res.duration == 1 ? '' : 's'}`;
            } else if (res.period === 'weekly') {
              durationStr = `${res.duration} week${res.duration == 1 ? '' : 's'}`;
            } else if (res.period === 'monthly') {
              durationStr = `${res.duration} month${res.duration == 1 ? '' : 's'}`;
            } else {
              durationStr = `${res.duration} ${res.period}`;
            }
            // Card style for each booking
            li.style.background = '#23272f';
            // Systematic border color logic
            let borderColor = 'var(--accent-color, #22C55E)';
            if (res.status === 'Payment Awaiting' && res.extraBill && res.extraBill > 0) {
              borderColor = '#f33'; // Red for actionable payment
            } else if (res.status === 'Completed') {
              borderColor = '#181F2A'; // Dark border for completed
            }
            li.style.border = `2px solid ${borderColor}`;
            li.style.borderRadius = '12px';
            li.style.margin = '1.2rem 0';
            li.style.padding = '1.2rem 1.5rem';
            li.style.boxShadow = '0 2px 12px rgba(0,0,0,0.10)';
            li.style.position = 'relative';
            li.style.listStyle = 'none';
            // Status color and label
            let statusColor = '#ffd400';
            let statusLabel = res.status;
            if (res.status === 'Cancelled') {
              statusColor = '#f33';
              statusLabel = 'CANCELLED';
            } else if (res.status === 'Completed') {
              statusColor = '#22C55E';
              statusLabel = 'COMPLETED';
            } else if (res.status === 'Payment Awaiting') {
              statusColor = '#f33';
              statusLabel = 'PAYMENT AWAITING';
            } else if (res.status === 'Released') {
              statusColor = '#ffd400';
              statusLabel = 'RELEASED';
            } else if (res.status === 'Payment Collected') {
              statusColor = '#22C55E';
              statusLabel = 'DEPOSIT COLLECTED';
            } else if (res.status === 'Reserved') {
              statusColor = '#ffd400';
              statusLabel = 'RESERVED';
            }
            // Add rental ID at the top, same font as rest
            let rentalIdHtml = res.rentalId ? `<div><strong>Rental ID:</strong> ${res.rentalId}</div>` : '';
            // Extra bill/damage info
            let extraHtml = '';
            if (res.extraBill && res.extraBill > 0) {
              extraHtml = `<div><strong>Extra Bill:</strong> $${res.extraBill} <br><strong>Notes:</strong> ${res.extraNotes || ''}</div>`;
            } else if (res.extraNotes) {
              extraHtml = `<div><strong>Notes:</strong> ${res.extraNotes}</div>`;
            }
            li.innerHTML =
              rentalIdHtml +
              `<div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:1.2rem;font-weight:700;color:var(--accent-color);">${res.model}</span>
                <span style="font-size:1rem;font-weight:600;color:${statusColor};text-transform:uppercase;">${statusLabel}</span>
              </div>
              <div style="margin-top:0.7rem;">
                ${(() => {
                  // Pickup From with map link and capitalization
                  let loc = (res.store || '').toLowerCase();
                  let locName = '';
                  let mapUrl = '';
                  if (loc === 'orchard') {
                    locName = 'Orchard';
                    mapUrl = 'https://www.google.com/maps/place/391+Orchard+Road,+Ngee+Ann+City,+Singapore+238872';
                  } else if (loc === 'changi') {
                    locName = 'Changi';
                    mapUrl = 'https://www.google.com/maps/place/Changi+Airport+Terminal+3,+Singapore+819643';
                  } else {
                    locName = res.store ? res.store.charAt(0).toUpperCase() + res.store.slice(1) : '';
                    mapUrl = '';
                  }
                  if (locName && mapUrl) {
                    return `<strong>Pickup From:</strong> <a href="${mapUrl}" target="_blank" rel="noopener" style="color:var(--accent-color);text-decoration:underline;">${locName}</a><br>`;
                  } else if (locName) {
                    return `<strong>Pickup From:</strong> ${locName}<br>`;
                  } else {
                    return '';
                  }
                })()}
                ${(() => {
                  // Show Return To only for Released, Payment Awaiting, Completed
                  const releasedStatuses = ['Released', 'Payment Awaiting', 'Completed'];
                  if (!releasedStatuses.includes(res.status)) return '';
                  let loc = (res.store || '').toLowerCase();
                  let locName = '';
                  let mapUrl = '';
                  if (loc === 'orchard') {
                    locName = 'Orchard';
                    mapUrl = 'https://www.google.com/maps/place/391+Orchard+Road,+Ngee+Ann+City,+Singapore+238872';
                  } else if (loc === 'changi') {
                    locName = 'Changi';
                    mapUrl = 'https://www.google.com/maps/place/Changi+Airport+Terminal+3,+Singapore+819643';
                  } else {
                    locName = res.store ? res.store.charAt(0).toUpperCase() + res.store.slice(1) : '';
                    mapUrl = '';
                  }
                  if (locName && mapUrl) {
                    return `<strong>Return To:</strong> <a href="${mapUrl}" target="_blank" rel="noopener" style="color:var(--accent-color);text-decoration:underline;">${locName}</a><br>`;
                  } else if (locName) {
                    return `<strong>Return To:</strong> ${locName}<br>`;
                  } else {
                    return '';
                  }
                })()}
                <strong>Start Date:</strong> ${res.startDate}<br>
                <strong>Duration:</strong> ${durationStr}<br>
                <strong>Cost:</strong> ${res.cost}<br>
              </div>`;
            // Show damage breakdown if present and status is Payment Awaiting
            if (res.status === 'Payment Awaiting' && Array.isArray(res.damageItems) && res.damageItems.length > 0) {
              let breakdownHtml = `<div style='margin:0.7rem 0 0.5rem 0;'><strong>Damage Charges Breakdown:</strong></div>`;
              breakdownHtml += `<ul style='margin:0 0 0.7rem 1.2rem;padding:0;'>`;
              res.damageItems.forEach(function(item) {
                breakdownHtml += `<li style='margin-bottom:0.3rem;'><strong>${item.type}</strong> - $${parseFloat(item.amount).toFixed(2)}`;
                if (item.comment) breakdownHtml += `<br><span style='color:#bbb;font-size:0.97em;'>${item.comment}</span>`;
                breakdownHtml += `</li>`;
              });
              breakdownHtml += `</ul>`;
              breakdownHtml += `<strong>Total Damage Charges:</strong> $${res.extraBill ? parseFloat(res.extraBill).toFixed(2) : '0.00'}<br>`;
              li.innerHTML += breakdownHtml;
              // Add Pay Now button for customer
              const payBtnId = `payBtn_${res.rentalId}`;
              const modalId = `payModal_${res.rentalId}`;
              li.innerHTML += `<button id='${payBtnId}' style='margin-top:1rem;background:#22C55E;color:#fff;font-weight:700;border:none;border-radius:6px;padding:0.6rem 1.2rem;cursor:pointer;'>Pay Now</button>`;
              li.innerHTML += `
                <div id='${modalId}' style='display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;align-items:center;justify-content:center;'>
                  <div style='background:#23272f;padding:2rem 2.5rem;border-radius:12px;max-width:350px;width:90vw;box-shadow:0 4px 32px rgba(0,0,0,0.18);position:relative;'>
                    <button id='close_${modalId}' style='position:absolute;top:0.7rem;right:1rem;background:none;border:none;font-size:1.5rem;color:#fff;cursor:pointer;'>&times;</button>
                    <h3 style='color:#22C55E;margin-bottom:1.2rem;'>Pay Damage Charges</h3>
                    <form id='form_${modalId}'>
                      <label style='color:#fff;'>Card Number</label>
                      <input type='text' id='ccnum_${modalId}' maxlength='19' placeholder='1234 5678 9012 3456' style='width:100%;margin-bottom:0.7rem;padding:0.5rem;border-radius:6px;border:1px solid #bbb;'>
                      <label style='color:#fff;'>Expiry (MM/YY)</label>
                      <input type='text' id='ccexp_${modalId}' maxlength='5' placeholder='MM/YY' style='width:100%;margin-bottom:0.7rem;padding:0.5rem;border-radius:6px;border:1px solid #bbb;'>
                      <label style='color:#fff;'>CVC</label>
                      <input type='text' id='cccvc_${modalId}' maxlength='4' placeholder='CVC' style='width:100%;margin-bottom:1.1rem;padding:0.5rem;border-radius:6px;border:1px solid #bbb;'>
                      <button type='submit' style='background:#22C55E;color:#fff;font-weight:700;border:none;border-radius:6px;padding:0.6rem 1.2rem;cursor:pointer;width:100%;'>Pay $${res.extraBill ? parseFloat(res.extraBill).toFixed(2) : '0.00'}</button>
                      <div id='err_${modalId}' style='color:#f33;font-weight:700;text-align:center;margin-top:0.7rem;display:none;'></div>
                    </form>
                  </div>
                </div>
              `;
              setTimeout(() => {
                const payBtn = document.getElementById(payBtnId);
                const modal = document.getElementById(modalId);
                const closeBtn = document.getElementById('close_' + modalId);
                const form = document.getElementById('form_' + modalId);
                const errDiv = document.getElementById('err_' + modalId);
                if (payBtn && modal && closeBtn && form) {
                  payBtn.onclick = function() { modal.style.display = 'flex'; };
                  closeBtn.onclick = function() { modal.style.display = 'none'; };
                  form.onsubmit = function(e) {
                    e.preventDefault();
                    errDiv.style.display = 'none';
                    const ccnum = document.getElementById('ccnum_' + modalId).value.trim();
                    const ccexp = document.getElementById('ccexp_' + modalId).value.trim();
                    const cccvc = document.getElementById('cccvc_' + modalId).value.trim();
                    if (!/^\d{4} ?\d{4} ?\d{4} ?\d{4}$/.test(ccnum)) {
                      errDiv.textContent = 'Invalid card number.';
                      errDiv.style.display = 'block';
                      return;
                    }
                    if (!/^\d{2}\/\d{2}$/.test(ccexp)) {
                      errDiv.textContent = 'Invalid expiry.';
                      errDiv.style.display = 'block';
                      return;
                    }
                    if (!/^\d{3,4}$/.test(cccvc)) {
                      errDiv.textContent = 'Invalid CVC.';
                      errDiv.style.display = 'block';
                      return;
                    }
                    // Mark as paid
                    let all = [];
                    try { all = JSON.parse(localStorage.getItem('azoom_reservations') || '[]'); } catch {}
                    const idx = all.findIndex(r => r.rentalId === res.rentalId);
                    if (idx !== -1) {
                      all[idx].status = 'Completed';
                      localStorage.setItem('azoom_reservations', JSON.stringify(all));
                      renderReservations();
                    }
                    modal.style.display = 'none';
                  };
                }
              }, 0);
            } else if (res.extraBill && res.extraBill > 0) {
              li.innerHTML += `<div><strong>Extra Bill:</strong> $${res.extraBill} <br><strong>Notes:</strong> ${res.extraNotes || ''}</div>`;
            } else if (res.extraNotes) {
              li.innerHTML += `<div><strong>Notes:</strong> ${res.extraNotes}</div>`;
            }
            // Add cancel button if reservation is active
            if (res.status === 'Reserved') {
              const btn = document.createElement('button');
              btn.className = 'cancel-btn';
              btn.textContent = 'Cancel Reservation';
              btn.style.marginTop = '1rem';
              btn.style.background = '#f33';
              btn.style.color = '#fff';
              btn.style.fontWeight = '700';
              btn.style.border = 'none';
              btn.style.borderRadius = '6px';
              btn.style.padding = '0.6rem 1.2rem';
              btn.style.cursor = 'pointer';
              btn.addEventListener('click', function() {
                // Update reservation status in localStorage
                let all = [];
                try { all = JSON.parse(localStorage.getItem('azoom_reservations') || '[]'); } catch {}
                const idx = all.findIndex(r => r.user === res.user && r.model === res.model && r.startDate === res.startDate && r.status === 'Reserved');
                if (idx !== -1) {
                  all[idx].status = 'Cancelled';
                  localStorage.setItem('azoom_reservations', JSON.stringify(all));
                  renderReservations();
                }
              });
              li.appendChild(btn);
            }
            // Add receipt button (only if completed)
            if (res.status === 'Completed') {
              const receiptBtn = document.createElement('button');
              receiptBtn.className = 'cancel-btn';
              receiptBtn.textContent = 'View Receipt';
              receiptBtn.style.marginLeft = '1rem';
              receiptBtn.style.background = '#222';
              receiptBtn.style.color = '#fff';
              receiptBtn.style.fontWeight = '700';
              receiptBtn.style.border = 'none';
              receiptBtn.style.borderRadius = '6px';
              receiptBtn.style.padding = '0.6rem 1.2rem';
              receiptBtn.style.cursor = 'pointer';
              receiptBtn.addEventListener('click', function() {
                window.open('receipt.html?id=' + encodeURIComponent(res.rentalId), '_blank');
              });
              li.appendChild(receiptBtn);
            }
            list.appendChild(li);

        // Receipt modal logic
        function showReceipt(res) {
          let html = `<div style='font-size:1.1rem;line-height:1.7;'>`;
          html += `<h2>Rental Receipt</h2>`;
          html += `<b>Rental ID:</b> ${res.rentalId || ''}<br>`;
          html += `<b>Customer:</b> ${res.user}<br>`;
          html += `<b>Car:</b> ${res.model}<br>`;
          html += `<b>Pickup:</b> ${res.store}<br>`;
          html += `<b>Start Date:</b> ${res.startDate}<br>`;
          html += `<b>Duration:</b> ${res.duration} ${res.period}<br>`;
          html += `<b>Status:</b> ${res.status}<br>`;
          html += `<b>Base Cost:</b> ${res.cost || ''}<br>`;
          if (res.extraBill && res.extraBill > 0) {
            html += `<b>Extra Bill:</b> $${res.extraBill}<br>`;
          }
          if (res.extraNotes) {
            html += `<b>Notes:</b> ${res.extraNotes}<br>`;
          }
          html += `<b>Created:</b> ${res.created ? new Date(res.created).toLocaleString() : ''}<br>`;
          html += `</div>`;
          // Print and close
          html += `<div style='margin-top:1.5rem;'><button onclick='window.print()' style='margin-right:1rem;'>Print</button><button onclick='document.body.removeChild(document.getElementById("receiptModal"))'>Close</button></div>`;
          let modal = document.createElement('div');
          modal.id = 'receiptModal';
          modal.style.position = 'fixed';
          modal.style.top = '0';
          modal.style.left = '0';
          modal.style.width = '100vw';
          modal.style.height = '100vh';
          modal.style.background = 'rgba(0,0,0,0.4)';
          modal.style.display = 'flex';
          modal.style.alignItems = 'center';
          modal.style.justifyContent = 'center';
          modal.style.zIndex = '9999';
          let inner = document.createElement('div');
          inner.style.background = '#fff';
          inner.style.padding = '2rem 2.5rem';
          inner.style.borderRadius = '12px';
          inner.style.boxShadow = '0 4px 32px rgba(0,0,0,0.18)';
          inner.innerHTML = html;
          modal.appendChild(inner);
          modal.addEventListener('click', function(e) {
            if (e.target === modal) document.body.removeChild(modal);
          });
          document.body.appendChild(modal);
        }
              // Logout button logic (main and dropdown)
              function logoutAndRedirect() {
                localStorage.removeItem('azoom_logged_in');
                localStorage.removeItem('azoom_user');
                  window.location.href = 'index.html#home';
              }
              const logoutBtnMain = document.getElementById('logoutBtnMain');
              if (logoutBtnMain) {
                logoutBtnMain.addEventListener('click', logoutAndRedirect);
              }
              const logoutBtn = document.getElementById('logoutBtn');
              if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                  e.preventDefault();
                  logoutAndRedirect();
                });
              }
          });
        }
        renderReservations();
        window.addEventListener('storage', renderReservations);
    // Hamburger menu logic
    const hamburger = document.getElementById("hamburger");
    const menu = document.getElementById("hamburger-menu");
    hamburger.addEventListener("click", (e) => {
      e.stopPropagation();
      menu.classList.toggle("active");
    });
    document.addEventListener("click", () => {
      menu.classList.remove("active");
    });

    // Auth UI logic (reuse from index.html)
    function updateAuthUI() {
      const loggedIn = localStorage.getItem('azoom_logged_in') === 'true';
      const userMenu = document.getElementById('userMenu');
      if (userMenu) userMenu.style.display = loggedIn ? 'inline-block' : 'none';
      const userMenuBtn = document.getElementById('userMenuBtn');
      const user = localStorage.getItem('azoom_user') || 'User';
      if (userMenuBtn) userMenuBtn.textContent = user + ' ‚ñº';
    }
    updateAuthUI();
    window.addEventListener('storage', updateAuthUI);

    // (Removed duplicate logout and cancel reservation logic. Now handled in renderReservations and logoutAndRedirect.)
  </script>
</body>
</html>